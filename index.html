<!-- Firebase App (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDqu2piOUjWzQBqUcXDH1qsbm5W4kbWerI",
    authDomain: "last-test-dbe42.firebaseapp.com",
    databaseURL: "https://last-test-dbe42-default-rtdb.firebaseio.com",
    projectId: "last-test-dbe42",
    storageBucket: "last-test-dbe42.firebasestorage.app",
    messagingSenderId: "1050805510999",
    appId: "1:1050805510999:web:e5bf098b8e24a490f75412",
    measurementId: "G-324WRRJQTW"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Generate 15-digit ID
  function generateUniqueId() {
    let id = "";
    for (let i = 0; i < 15; i++) {
      id += Math.floor(Math.random() * 10);
    }
    return id;
  }

  // Emoji list
  const emojis = ["😀","😁","😂","😃","😄","😅","😆","😇","😈","😉","😊","😋","😎","😍","🤩","😜","🤪"];

  // Generate random emoji string
  function generateRandomEmojiString() {
    const lengths = [7,8,9,10];
    const randomLength = lengths[Math.floor(Math.random() * lengths.length)];
    let str = "";
    for (let i=0; i<randomLength; i++) {
      str += emojis[Math.floor(Math.random() * emojis.length)];
    }
    return str;
  }

  // Save to Firebase: store encodedMessage + originalMessage
  function saveMessage(id, text, emoji) {
    const encodedMessage = emoji + " | ID: " + id;
    firebase.database().ref("messages/" + id).set({
      originalMessage: text,
      encodedMessage: encodedMessage,
      emoji: emoji
    });
  }

  // Retrieve from Firebase
  function retrieveMessage(id) {
    return firebase.database().ref("messages/" + id).once("value").then(s => s.val());
  }

  // Copy helper
  function copyText(text) {
    navigator.clipboard.writeText(text).then(()=>alert("Copied: " + text));
  }

  // Handle Encode
  document.getElementById("encodeForm").addEventListener("submit", e => {
    e.preventDefault();
    const textInput = document.getElementById("textInput").value.trim();
    if (!textInput) return;

    const emojiStr = generateRandomEmojiString();
    const uniqueId = generateUniqueId();
    saveMessage(uniqueId, textInput, emojiStr);

    // Show result
    const resultDiv = document.getElementById("encodeResult");
    resultDiv.style.display = "block";
    resultDiv.innerHTML =
      "<strong>Encoded Emoji:</strong> " + emojiStr +
      " <button class='copy-btn' onclick=\"copyText('" + emojiStr + "')\">Copy</button><br><br>" +
      "<strong>Your 15-digit ID:</strong> " + uniqueId +
      " <button class='copy-btn' onclick=\"copyText('" + uniqueId + "')\">Copy</button>";

    const shareText = "Encoded Emoji: " + emojiStr + " | ID: " + uniqueId;
    document.getElementById("twitterShare").href = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(shareText);
    document.getElementById("facebookShare").href = "https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(window.location.href) + "&quote=" + encodeURIComponent(shareText);
    document.getElementById("whatsappShare").href = "https://api.whatsapp.com/send?text=" + encodeURIComponent(shareText);
    document.getElementById("shareSection").style.display = "block";
  });

  // Handle Decode
  document.getElementById("decodeForm").addEventListener("submit", e => {
    e.preventDefault();
    const emojiInput = document.getElementById("emojiInput").value.trim();
    const idInput = document.getElementById("idInput").value.trim();
    const resultDiv = document.getElementById("decodeResult");
    resultDiv.style.display = "block";

    retrieveMessage(idInput).then(data => {
      if (data) {
        if (data.emoji === emojiInput) {
          resultDiv.innerHTML =
            "<strong>Encoded Message:</strong> " + data.encodedMessage +
            "<br><br><strong>Decoded Message:</strong> " + data.originalMessage;
        } else {
          resultDiv.innerHTML = "<strong>Error:</strong> Emoji does not match this ID.";
        }
      } else {
        resultDiv.innerHTML = "<strong>Error:</strong> No message found for this ID.";
      }
    });
  });
</script>
