<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Text to Emoji Encoder/Decoder</title>
  <style>
    /* Base styling */
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1 { text-align: center; }
    form { margin-bottom: 30px; }
    textarea,
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1em;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }
    button:hover { background-color: #45a049; }
    .result {
      background: #e7f3fe;
      border-left: 6px solid #2196F3;
      padding: 10px;
      margin-top: 10px;
      word-wrap: break-word;
    }
    .tab {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .tab button {
      background-color: #ddd;
      border: none;
      padding: 10px 20px;
      margin: 0 5px;
      cursor: pointer;
      font-size: 1em;
      border-radius: 4px;
    }
    .tab button.active {
      background-color: #4CAF50;
      color: white;
    }
    .section {
      display: none;
    }
    .section.active { display: block; }
    /* Copy button styling */
    .copy-btn {
      margin-left: 10px;
      padding: 5px 10px;
      font-size: 0.9em;
    }
    /* Social share section styling */
    .share-section {
      margin-top: 20px;
      text-align: center;
    }
    .share-section h3 {
      margin-bottom: 10px;
    }
    .share-section a {
      margin: 0 5px;
      text-decoration: none;
      color: #fff;
      background-color: #4CAF50;
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 1em;
    }
    .share-section a:hover {
      background-color: #45a049;
    }
    .note {
      color: #555;
      font-size: 0.9em;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Text to Emoji Encoder/Decoder</h1>
    <div class="tab">
      <button class="tablinks active" onclick="openSection('encodeSection', event)">Encode</button>
      <button class="tablinks" onclick="openSection('decodeSection', event)">Decode</button>
    </div>

    <!-- Encode Section -->
    <div id="encodeSection" class="section active">
      <h2>Encode Your Message</h2>
      <form id="encodeForm">
        <textarea id="textInput" rows="4" placeholder="Enter your secret message here..." required></textarea>
        <button type="submit">Encode</button>
      </form>
      <div id="encodeResult" class="result" style="display:none;"></div>
      <div id="shareSection" class="share-section" style="display:none;">
        <h3>Share on Social Media</h3>
        <a href="#" id="twitterShare" target="_blank">Twitter</a>
        <a href="#" id="facebookShare" target="_blank">Facebook</a>
        <a href="#" id="whatsappShare" target="_blank">WhatsApp</a>
      </div>
      <div class="note">Tip: copy the entire emoji string exactly (no extra spaces) when you decode.</div>
    </div>

    <!-- Decode Section -->
    <div id="decodeSection" class="section">
      <h2>Decode Your Message</h2>
      <form id="decodeForm">
        <input type="text" id="emojiInput" placeholder="Enter the emoji code you received..." required />
        <input type="text" id="idInput" placeholder="Enter the 15-digit ID..." required />
        <button type="submit">Decode</button>
      </form>
      <div id="decodeResult" class="result" style="display:none;"></div>
    </div>
  </div>

  <!-- Firebase App (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ---------- Firebase configuration (your provided config) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDqu2piOUjWzQBqUcXDH1qsbm5W4kbWerI",
      authDomain: "last-test-dbe42.firebaseapp.com",
      databaseURL: "https://last-test-dbe42-default-rtdb.firebaseio.com",
      projectId: "last-test-dbe42",
      storageBucket: "last-test-dbe42.firebasestorage.app",
      messagingSenderId: "1050805510999",
      appId: "1:1050805510999:web:e5bf098b8e24a490f75412",
      measurementId: "G-324WRRJQTW"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- Helpers ----------
    function generateUniqueId() {
      let id = "";
      for (let i = 0; i < 15; i++) id += Math.floor(Math.random() * 10);
      return id;
    }

    const emojis = ["😀","😁","😂","😃","😄","😅","😆","😇","😈","😉","😊","😋","😎","😍","🤩","😜","🤪"];

    function generateRandomEmojiString() {
      const possibleLengths = [7,8,9,10];
      const randomLength = possibleLengths[Math.floor(Math.random()*possibleLengths.length)];
      let emojiStr = "";
      for (let i = 0; i < randomLength; i++) {
        const randomIndex = Math.floor(Math.random() * emojis.length);
        emojiStr += emojis[randomIndex];
      }
      return emojiStr;
    }

    // Normalize emoji string: remove variation selectors and trim spaces
    function normalizeEmoji(s) {
      if (!s && s !== "") return "";
      // remove FE0F (variation selector) and normalize whitespace
      return String(s).replace(/\uFE0F/g, "").replace(/\s+/g, "").trim();
    }

    function saveMessage(id, text, emoji) {
      const payload = {
        originalMessage: text,
        emoji: emoji,
        encodedMessage: emoji, // keep encoded message (emoji only) here
        createdAt: firebase.database.ServerValue.TIMESTAMP
      };
      return firebase.database().ref("messages/" + id).set(payload);
    }

    function retrieveMessage(id) {
      return firebase.database().ref("messages/" + id).once("value").then(snapshot => snapshot.val());
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert("Copied: " + text);
      }).catch(err => {
        alert("Failed to copy text");
        console.error(err);
      });
    }

    // ---------- UI helpers (safe DOM building) ----------
    function showEncodeResult(emojiStr, uniqueId) {
      const resultDiv = document.getElementById("encodeResult");
      resultDiv.style.display = "block";
      resultDiv.innerHTML = ""; // clear

      const label1 = document.createElement("strong");
      label1.textContent = "Encoded Emoji: ";
      resultDiv.appendChild(label1);

      const emojiSpan = document.createElement("span");
      emojiSpan.textContent = emojiStr;
      emojiSpan.style.marginRight = "8px";
      resultDiv.appendChild(emojiSpan);

      const copyEmojiBtn = document.createElement("button");
      copyEmojiBtn.className = "copy-btn";
      copyEmojiBtn.textContent = "Copy";
      copyEmojiBtn.addEventListener("click", () => copyText(emojiStr));
      resultDiv.appendChild(copyEmojiBtn);

      resultDiv.appendChild(document.createElement("br"));
      resultDiv.appendChild(document.createElement("br"));

      const label2 = document.createElement("strong");
      label2.textContent = "Your 15-digit ID: ";
      resultDiv.appendChild(label2);

      const idSpan = document.createElement("span");
      idSpan.textContent = uniqueId;
      idSpan.style.marginRight = "8px";
      resultDiv.appendChild(idSpan);

      const copyIdBtn = document.createElement("button");
      copyIdBtn.className = "copy-btn";
      copyIdBtn.textContent = "Copy";
      copyIdBtn.addEventListener("click", () => copyText(uniqueId));
      resultDiv.appendChild(copyIdBtn);
    }

    function showDecodeResultHTML(html) {
      const div = document.getElementById("decodeResult");
      div.style.display = "block";
      div.innerHTML = html;
    }

    // ---------- Tab switching ----------
    function openSection(sectionId, event) {
      const sections = document.getElementsByClassName("section");
      for (const section of sections) section.classList.remove("active");
      document.getElementById(sectionId).classList.add("active");

      const tabButtons = document.getElementsByClassName("tablinks");
      for (const btn of tabButtons) btn.classList.remove("active");
      if (event && event.target) event.target.classList.add("active");
    }

    // ---------- Encode flow ----------
    document.getElementById("encodeForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const textInput = document.getElementById("textInput").value;
      if (!textInput || textInput.trim() === "") return;

      const randomEmojiString = generateRandomEmojiString();
      const uniqueId = generateUniqueId();

      // Save to Firebase (returns a promise)
      saveMessage(uniqueId, textInput.trim(), randomEmojiString)
        .then(() => {
          showEncodeResult(randomEmojiString, uniqueId);

          const shareText = "Encoded Emoji: " + randomEmojiString + " | ID: " + uniqueId;
          document.getElementById("twitterShare").href = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(shareText);
          document.getElementById("facebookShare").href = "https://www.facebook.com/sharer/sharer.php?u=" + encodeURIComponent(window.location.href) + "&quote=" + encodeURIComponent(shareText);
          document.getElementById("whatsappShare").href = "https://api.whatsapp.com/send?text=" + encodeURIComponent(shareText);
          document.getElementById("shareSection").style.display = "block";
        })
        .catch(err => {
          console.error("Failed to save message:", err);
          alert("Failed to save message to Firebase. See console for details.");
        });
    });

    // ---------- Decode flow ----------
    document.getElementById("decodeForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const emojiInputRaw = document.getElementById("emojiInput").value || "";
      const idInput = (document.getElementById("idInput").value || "").trim();

      const resultDiv = document.getElementById("decodeResult");
      resultDiv.style.display = "block";
      resultDiv.innerHTML = "<em>Checking...</em>";

      if (!idInput) {
        showDecodeResultHTML("<strong>Error:</strong> Please enter the 15-digit ID.");
        return;
      }

      retrieveMessage(idInput)
        .then(data => {
          if (!data) {
            showDecodeResultHTML("<strong>Error:</strong> No message found for the provided ID.");
            return;
          }

          const storedEmoji = data.emoji || data.encodedMessage || "";
          const normStored = normalizeEmoji(storedEmoji);
          const normProvided = normalizeEmoji(emojiInputRaw);

          // Exact match or fuzzy contain match (helps if user accidentally omits/duplicates a char/space)
          const isExact = normStored === normProvided && normStored !== "";
          const isContained = normStored.includes(normProvided) && normProvided !== "";
          const providedContainsStored = normProvided.includes(normStored) && normStored !== "";

          if (isExact || isContained || providedContainsStored) {
            // Build a safe result display
            const enc = document.createElement("div");
            const strongEnc = document.createElement("strong");
            strongEnc.textContent = "Encoded Emoji: ";
            enc.appendChild(strongEnc);
            const encSpan = document.createElement("span");
            encSpan.textContent = storedEmoji;
            enc.appendChild(encSpan);

            const br = document.createElement("br");
            const br2 = document.createElement("br");

            const dec = document.createElement("div");
            const strongDec = document.createElement("strong");
            strongDec.textContent = "Decoded Message: ";
            dec.appendChild(strongDec);
            const decSpan = document.createElement("span");
            decSpan.textContent = data.originalMessage || "(empty)";
            dec.appendChild(decSpan);

            // Clear and append
            resultDiv.innerHTML = "";
            resultDiv.appendChild(enc);
            resultDiv.appendChild(br);
            resultDiv.appendChild(br2);
            resultDiv.appendChild(dec);
          } else {
            // Not matched
            let hint = "<strong>Error:</strong> The provided emoji does not match our records for this ID.";
            hint += "<br><br><em>Tip:</em> Make sure you pasted the full emoji string exactly (no extra spaces).";
            // For debugging you can uncomment below line to show stored emoji length/info:
            // hint += "<br><small>Debug: stored length = " + storedEmoji.length + ", provided length = " + emojiInputRaw.length + "</small>";
            showDecodeResultHTML(hint);
          }
        })
        .catch(err => {
          console.error("Failed to read from Firebase:", err);
          showDecodeResultHTML("<strong>Error:</strong> Failed to read data. See console for details.");
        });
    });

    // expose openSection to global scope for inline onclick in HTML
    window.openSection = openSection;
  </script>
</body>
</html>
